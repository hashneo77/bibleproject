<!doctype html>
<html lang="ml">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Verse Presentation</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Malayalam:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root{
      /* Light */
      --bg:#f5f6f7; --panel:#ffffff; --border:#d6d8db; --text:#111827; --muted:#6b7280;
      --chrome:#eef1f6;
    }
    body.dark{
      /* Dark */
      --bg:#0b1324; --panel:#0e172b; --border:#22335a; --text:#f5f7fb; --muted:#9aa4b2;
      --chrome:#101a33;
    }
    
    .footer-note{
      text-align:center;
      font-size:11px;
      color:var(--muted);
      margin-top:14px;
      padding:6px 0 10px;
    }

    *{ box-sizing: border-box; }
    html,body{ margin:0; height:100%; background:var(--bg); color:var(--text);
      font-family:"Noto Sans Malayalam", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .wrap{ display:grid; grid-template-rows:auto 1fr auto; min-height:100%; }
    header{
      display:flex; justify-content:space-between; align-items:center;
      padding:10px 14px; backdrop-filter:blur(6px);
      border-bottom:1px solid var(--border); background:rgba(8,12,24,.07);
    }
    #ref{ font-size:40px; font-weight:700; letter-spacing:.2px; }
    .controls{ display:flex; gap:8px; }
    .btn{ padding:8px 12px; border-radius:10px; border:1px solid var(--border);
      background:var(--panel); color:var(--text); font-weight:700; cursor:pointer; }
    .btn:hover{ background:var(--chrome); }
    .icon-btn{ min-width:34px; min-height:30px; padding:4px 6px; font-size:14px; }

    main{ display:flex; align-items:center; justify-content:center; padding:14px; }
    .slide{
      width:min(1800px,95vw); min-height:min(90vh,80svh);
      border-radius:20px; border:1px solid var(--border);
      background: radial-gradient(1400px 800px at 0% -20%, rgba(26,36,64,.7) 0%, rgba(13,20,38,.4) 40%);
      box-shadow:0 30px 70px rgba(0,0,0,.25);
      display:grid; place-items:center; padding: clamp(12px, 3vw, 28px);
      text-align:center;
    }
    #verseText{ white-space:pre-wrap; line-height:1.28; font-weight:700; font-size: clamp(45px, 15vw, 70px); letter-spacing:.2px; }
    footer{ text-align:center; color:var(--muted); font-size:12px; padding:10px 0 14px; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div id="ref">—</div>
      <div class="controls">
        <button id="prevBtn" class="btn" title="←">&#8592;</button>
        <button id="nextBtn" class="btn" title="→">&#8594;</button>
        <button id="fsBtn" class="btn" title="Full Screen">⤢</button>
        <button id="themeToggle" class="btn icon-btn" title="Toggle theme">🌙</button>
      </div>
    </header>

    <main>
      <div class="slide"><div id="verseText">…</div></div>
    </main>
    <footer>Made with &#x2665;&#xfe0f; by the Evangelisation Commission for Great Britain</footer>
  </div>

  <script>
    // -------- Theme (sync with index via localStorage) --------
    const THEME_KEY = "bible_theme";
    function applySavedTheme(){
      const saved = localStorage.getItem(THEME_KEY) || "dark";
      document.body.classList.toggle("dark", saved === "dark");
      document.getElementById("themeToggle").textContent = saved === "dark" ? "☀️" : "🌙";
    }
    applySavedTheme();
    document.getElementById("themeToggle").addEventListener("click", ()=>{
      const dark = !document.body.classList.contains("dark");
      document.body.classList.toggle("dark", dark);
      localStorage.setItem(THEME_KEY, dark ? "dark" : "light");
      document.getElementById("themeToggle").textContent = dark ? "☀️" : "🌙";
    });
    window.addEventListener("storage", (e)=>{ if(e.key === THEME_KEY) applySavedTheme(); });

    // -------- CSV + navigation (same as before) --------
    const normalize = s => (s ?? "").normalize("NFKC").replace(/\u200d/g,"").replace(/\u00A0/g," ").trim();
    const qs = new URLSearchParams(location.search);
    const startBook    = normalize(qs.get("book"));
    const startChapter = normalize(qs.get("chapter"));
    const startVerse   = normalize(qs.get("verse"));

    let ALL = [], BOOK_ONLY = [], idx = -1;

    function parseCSV(text){
      const rows=[]; let row=[], field="", q=false;
      for (let i=0;i<text.length;i++){
        const c=text[i], n=text[i+1];
        if(q){ if(c==='"' && n === '"'){ field+='"'; i++; } else if(c==='"'){ q=false; } else { field+=c; } }
        else{ if(c==='"'){ q=true; } else if(c===','){ row.push(field); field=""; }
              else if(c==='\n'){ row.push(field); rows.push(row); row=[]; field=""; }
              else if(c==='\r'){ } else { field+=c; } }
      }
      if(field.length || row.length){ row.push(field); rows.push(row); }
      const header = rows.shift() || [];
      return rows.map(r => Object.fromEntries(header.map((h,i)=>[h, r[i] ?? ""])));
    }

    async function load() {
      const res = await fetch("verses.csv", { cache: "no-store" });
      const raw = await res.text();
      const rows = parseCSV(raw);

      for (const r of rows){
        const t = normalize(r.Title);
        if (t && t.includes(":")){
          const [left, v] = t.split(":");
          const parts = normalize(left).split(" ");
          const ch = parts.pop() ?? ""; const b = parts.join(" ");
          r.Book = normalize(r.Book || b);
          r.Chapter = normalize(r.Chapter || ch);
          r.Verse = normalize(r.Verse || v);
        } else {
          r.Book = normalize(r.Book); r.Chapter = normalize(r.Chapter); r.Verse = normalize(r.Verse);
        }
        r.Text = r.Text ?? "";
      }

      ALL = rows.filter(r => r.Book && r.Chapter && r.Verse);
      BOOK_ONLY = ALL.filter(r => normalize(r.Book) === startBook);

      idx = BOOK_ONLY.findIndex(r =>
        normalize(r.Book)===startBook && normalize(r.Chapter)===startChapter && normalize(r.Verse)===startVerse
      );
      if (idx < 0) idx = 0;

      render();
    }

    function render(){
      const r = BOOK_ONLY[idx]; if(!r) return;
      document.getElementById("ref").textContent = `${r.Book} ${r.Chapter}:${r.Verse}`;
      document.getElementById("verseText").textContent = String(r.Text ?? "");
      document.title = `${r.Book} ${r.Chapter}:${r.Verse} — Presentation`;
      history.replaceState(null, document.title,
        `?book=${encodeURIComponent(r.Book)}&chapter=${encodeURIComponent(r.Chapter)}&verse=${encodeURIComponent(r.Verse)}`
      );
    }

    function nextRow(){ if(idx < BOOK_ONLY.length-1){ idx++; render(); } }
    function prevRow(){ if(idx > 0){ idx--; render(); } }

    document.getElementById("nextBtn").addEventListener("click", nextRow);
    document.getElementById("prevBtn").addEventListener("click", prevRow);
    window.addEventListener("keydown", (e)=>{ if(e.key==="ArrowRight"){ e.preventDefault(); nextRow(); } else if(e.key==="ArrowLeft"){ e.preventDefault(); prevRow(); } });

    // Fullscreen
    const fsBtn = document.getElementById("fsBtn");
    function fsActive(){ return !!(document.fullscreenElement || document.webkitFullscreenElement); }
    function enterFS(){ (document.documentElement.requestFullscreen || document.documentElement.webkitRequestFullscreen).call(document.documentElement); }
    function exitFS(){ (document.exitFullscreen || document.webkitExitFullscreen).call(document); }
    fsBtn.addEventListener("click", ()=>{ fsActive()?exitFS():enterFS(); });
    document.addEventListener("fullscreenchange", ()=>{ fsBtn.textContent = fsActive() ? "⤡" : "⤢ "; });

    load().catch(e => { console.error(e); alert("Failed to load verses.csv"); });
  </script>
</body>
</html>
