<!DOCTYPE html>
<html lang="ml">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bible Verse Navigator (Web)</title>
  <!-- Malayalam font -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Malayalam:wght@400;700&display=swap" rel="stylesheet">
  <!-- PapaParse for CSV parsing -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root {
      --bg: #0b1020;
      --panel: #121933;
      --panel-2: #0f1630;
      --text: #e8ecff;
      --muted: #9fb0ff;
      --accent: #6ea8ff;
      --btn: #1c2752;
      --btn-hover: #253163;
      --chip: #1a234a;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; background: var(--bg); color: var(--text);
      font-family: "Noto Sans Malayalam", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
    }
    header {
      position: sticky; top: 0; z-index: 5; backdrop-filter: blur(8px);
      border-bottom: 1px solid #223;
      background: linear-gradient(180deg, rgba(11,16,32,0.9), rgba(11,16,32,0.6));
    }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 16px; }
    h1 { margin: 0; font-size: 20px; letter-spacing: 0.3px; color: var(--muted); }

    .grid {
      display: grid; gap: 12px; grid-template-columns: 330px 1fr;
    }
    @media (max-width: 960px) {
      .grid { grid-template-columns: 1fr; }
    }

    .panel { background: var(--panel); border: 1px solid #1a2144; border-radius: 16px; }
    .panel h2 { margin: 0; padding: 12px 14px; font-size: 14px; color: var(--muted); border-bottom: 1px solid #1a2144; }
    .panel-body { padding: 12px; }

    .chips { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 8px; }
    .chip { background: var(--chip); border: 1px solid #223058; color: var(--text); padding: 8px 10px; border-radius: 999px; cursor: pointer; text-align: center; font-size: 13px; }
    .chip:hover { background: #223058; }
    .chip.sep { opacity: 0; pointer-events: none; height: 0; padding: 0; margin: 0; }
    .chip.active { outline: 2px solid var(--accent); outline-offset: 2px; }

    .tiny-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(42px, 1fr)); gap: 6px; }
    .tiny-btn { background: var(--btn); border: 1px solid #1d2750; color: var(--text); padding: 8px 0; border-radius: 10px; cursor: pointer; font-size: 13px; }
    .tiny-btn:hover { background: var(--btn-hover); }
    .tiny-btn.active { outline: 2px solid var(--accent); outline-offset: 2px; background: #223058; }

    .viewer { background: var(--panel-2); border: 1px solid #1a2144; border-radius: 16px; padding: 16px; display: flex; flex-direction: column; gap: 12px; }
    .ref { font-weight: 700; font-size: 18px; color: var(--muted); text-align: center; }
    .verse {
      font-weight: 700; font-size: clamp(26px, 7vw, 52px); line-height: 1.25; text-align: center; white-space: pre-wrap;
      padding: 10px 8px; min-height: 180px; display: flex; align-items: center; justify-content: center;
    }

    .controls { display: flex; gap: 10px; justify-content: center; align-items: center; flex-wrap: wrap; }
    .btn { background: var(--btn); border: 1px solid #1d2750; color: var(--text); padding: 10px 14px; border-radius: 12px; cursor: pointer; font-size: 14px; }
    .btn:hover { background: var(--btn-hover); }

    .tips { text-align: center; color: var(--muted); font-size: 12px; }
    .sr { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }

    .footer { color: var(--muted); font-size: 12px; text-align: center; padding: 16px 0; }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>üìñ Bible Verse Navigator</h1>
    </div>
  </header>

  <main class="wrap" id="app">
    <div class="grid">
      <section class="panel" aria-labelledby="booksLabel">
        <h2 id="booksLabel">‡¥™‡µÅ‡¥∏‡µç‡¥§‡¥ï‡¥ô‡µç‡¥ô‡¥≥‡µç‚Äç (Books)</h2>
        <div class="panel-body">
          <div id="books" class="chips" role="listbox" aria-label="Books list"></div>
        </div>

        <h2 id="chaptersLabel">‡¥Ö‡¥ß‡µç‡¥Ø‡¥æ‡¥Ø‡¥ô‡µç‡¥ô‡¥≥‡µç‚Äç (Chapters)</h2>
        <div class="panel-body">
          <div id="chapters" class="tiny-grid" role="listbox" aria-labelledby="chaptersLabel"></div>
        </div>

        <h2 id="versesLabel">‡¥µ‡¥ö‡¥®‡¥ô‡µç‡¥ô‡¥≥‡µç‚Äç (Verses)</h2>
        <div class="panel-body">
          <div id="verses" class="tiny-grid" role="listbox" aria-labelledby="versesLabel"></div>
        </div>
      </section>

      <section class="viewer" aria-live="polite">
        <div class="ref" id="ref">&nbsp;</div>
        <div class="verse" id="verse">‡¥µ‡¥ö‡¥®‡¥Ç ‡¥§‡¥ø‡¥∞‡¥û‡µç‡¥û‡µÜ‡¥ü‡µÅ‡¥ï‡µç‡¥ï‡µÅ‡¥ï (Select a verse)</div>
        <div class="controls">
          <button class="btn" id="prevBtn" title="Previous (‚Üê)">‚Üê Previous</button>
          <button class="btn" id="nextBtn" title="Next (‚Üí)">Next ‚Üí</button>
          <button class="btn" id="openPresentationBtn" title="Open a separate presentation window (P)">üñ•Ô∏è Open Presentation</button>
        </div>
        <p class="tips">Tip: Use your keyboard ‚Üê and ‚Üí to move between verses. Press <kbd>P</kbd> to open presentation.</p>
      </section>
    </div>

    <p class="footer">Load your <code>verses.csv</code> in the same folder as this page. CSV must have headers: <code>Title,Text</code>.</p>
  </main>

  <script>
    // ===== Helpers =====
    function normalizeText(t) {
      if (!t) return '';
      try { t = t.normalize('NFKC'); } catch (e) {}
      return t.replace(/\u200d/g, '').replace(/\u00A0/g, ' ').trim();
    }
    function safeInt(s) {
      const n = parseInt(s, 10); return Number.isFinite(n) ? n : -1;
    }
    function uniqueOrdered(arr) {
      const seen = new Set();
      const out = [];
      for (const x of arr) { if (!seen.has(x)) { seen.add(x); out.push(x); } }
      return out;
    }

    // ===== Data & State =====
    const BOOKS = [
      "‡¥â‡¥≤‡µç‚Äç‚Äç‡¥™‡¥§‡µç‡¥§‡¥ø", "‡¥™‡µÅ‡¥±‡¥™‡µç‡¥™‡¥æ‡¥ü‡µç", "‡¥≤‡µá‡¥µ‡µç‡¥Ø‡¥∞‡µç‚Äç", "‡¥∏‡¥Ç‡¥ñ‡µç‡¥Ø", "‡¥®‡¥ø‡¥Ø‡¥Æ‡¥æ‡¥µ‡¥∞‡µç‚Äç‡¥§‡µç‡¥§‡¥®‡¥Ç",
      "‡¥ú‡µã‡¥∑‡µç‡¥µ‡¥æ", "‡¥®‡µç‡¥Ø‡¥æ‡¥Ø‡¥æ‡¥ß‡¥ø‡¥™‚Äå‡¥®‡µç‚Äç‡¥Æ‡¥æ‡¥∞‡µç‚Äç", "‡¥±‡µÇ‡¥§‡µç‡¥§‡µç",
      "1 ‡¥∏‡¥æ‡¥Æ‡µÅ‡¥µ‡¥≤‡µç‚Äç", "2 ‡¥∏‡¥æ‡¥Æ‡µÅ‡¥µ‡¥≤‡µç‚Äç","****", "1 ‡¥∞‡¥æ‡¥ú‡¥æ‡¥ï‡µç‡¥ï‚Äå‡¥®‡µç‚Äç‡¥Æ‡¥æ‡¥∞‡µç‚Äç", "2 ‡¥∞‡¥æ‡¥ú‡¥æ‡¥ï‡µç‡¥ï‚Äå‡¥®‡µç‚Äç‡¥Æ‡¥æ‡¥∞‡µç‚Äç",
      "1 ‡¥¶‡¥ø‡¥®‡¥µ‡µÉ‡¥§‡µç‡¥§‡¥æ‡¥®‡µç‡¥§‡¥Ç", "2 ‡¥¶‡¥ø‡¥®‡¥µ‡µÉ‡¥§‡µç‡¥§‡¥æ‡¥®‡µç‡¥§‡¥Ç", "‡¥é‡¥∏‡µç‡¥∞‡¥æ", "‡¥®‡µÜ‡¥π‡¥Æ‡¥ø‡¥Ø", "‡¥§‡µã‡¥¨‡¥ø‡¥§‡µç",
      "‡¥Ø‡µÇ‡¥¶‡¥ø‡¥§‡µç‡¥§‡µç", "‡¥é‡¥∏‡µç‡¥§‡µá‡¥∞‡µç‚Äç", "1 ‡¥Æ‡¥ï‡µç‡¥ï‡¥¨‡¥æ‡¥Ø‡¥∞‡µç‚Äç", "2 ‡¥Æ‡¥ï‡µç‡¥ï‡¥¨‡¥æ‡¥Ø‡¥∞‡µç‚Äç", "‡¥ú‡µã‡¥¨‡µç","****",
      "‡¥∏‡¥ô‡µç‡¥ï‡µÄ‡¥∞‡µç‚Äç‡¥§‡µç‡¥§‡¥®‡¥ô‡µç‡¥ô‡¥≥‡µç‚Äç", "‡¥∏‡µÅ‡¥≠‡¥æ‡¥∑‡¥ø‡¥§‡¥ô‡µç‡¥ô‡¥≥‡µç‚Äç", "‡¥∏‡¥≠‡¥æ‡¥™‡µç‡¥∞‡¥∏‡¥Ç‡¥ó‡¥ï‚Äå‡¥®‡µç‚Äç","****", "‡¥â‡¥§‡µç‡¥§‡¥Æ‡¥ó‡µÄ‡¥§‡¥Ç",
      "‡¥ú‡µç‡¥û‡¥æ‡¥®‡¥Ç", "‡¥™‡µç‡¥∞‡¥≠‡¥æ‡¥∑‡¥ï‚Äå‡¥®‡µç‚Äç", "‡¥è‡¥∂‡¥Ø‡µç‡¥Ø‡¥æ", "‡¥ú‡µÜ‡¥±‡µÜ‡¥Æ‡¥ø‡¥Ø", "‡¥µ‡¥ø‡¥≤‡¥æ‡¥™‡¥ô‡µç‡¥ô‡¥≥‡µç‚Äç", "‡¥¨‡¥æ‡¥±‡µÇ‡¥ï‡µç‡¥ï‡µç",
      "‡¥é‡¥∏‡µÜ‡¥ï‡µç‡¥ï‡¥ø‡¥Ø‡µá‡¥≤‡µç‚Äç", "‡¥¶‡¥æ‡¥®‡¥ø‡¥Ø‡µá‡¥≤‡µç‚Äç", "****","‡¥π‡µã‡¥∏‡¥ø‡¥Ø‡¥æ", "‡¥ú‡µã‡¥Ø‡µá‡¥≤‡µç‚Äç", "‡¥Ü‡¥Æ‡µã‡¥∏‡µç", "‡¥í‡¥¨‡¥æ‡¥¶‡¥ø‡¥Ø",
      "‡¥Ø‡µã‡¥®‡¥æ", "‡¥Æ‡¥ø‡¥ï‡µç‡¥ï‡¥æ", "‡¥®‡¥æ‡¥π‡µÅ‡¥Ç", "‡¥π‡¥¨‡¥ï‡µç‡¥ï‡µÅ‡¥ï‡µç‡¥ï‡µç", "‡¥∏‡µÜ‡¥´‡¥æ‡¥®‡¥ø‡¥Ø", "‡¥π‡¥ó‡µç‡¥ó‡¥æ‡¥Ø‡¥ø",
      "‡¥∏‡¥ñ‡¥±‡¥ø‡¥Ø‡¥æ", "‡¥Æ‡¥≤‡¥æ‡¥ï‡µç‡¥ï‡¥ø", "****", "‡¥Æ‡¥§‡µç‡¥§‡¥æ‡¥Ø‡¥ø", "‡¥Æ‡¥∞‡µç‚Äç‡¥ï‡µç‡¥ï‡µã‡¥∏‡µç", "‡¥≤‡µÇ‡¥ï‡µç‡¥ï‡¥æ", "‡¥Ø‡µã‡¥π‡¥®‡µç‡¥®‡¥æ‚Äå‡¥®‡µç‚Äç",
      "‡¥Ö‡¥™‡µç‡¥™. ‡¥™‡µç‡¥∞‡¥µ‡µº‡¥§‡µç‡¥§‡¥®‡¥ô‡µç‡¥ô‡¥≥‡µç‚Äç", "****","‡¥±‡µã‡¥Æ‡¥æ", "1 ‡¥ï‡µä‡¥±‡¥ø‡¥®‡µç‡¥§‡µã‡¥∏‡µç", "2 ‡¥ï‡µä‡¥±‡¥ø‡¥®‡µç‡¥§‡µã‡¥∏‡µç", "‡¥ó‡¥≤‡¥æ‡¥§‡µç‡¥§‡¥ø‡¥Ø‡¥æ",
      "‡¥é‡¥´‡µá‡¥∏‡µã‡¥∏‡µç", "‡¥´‡¥ø‡¥≤‡¥ø‡¥™‡µç‡¥™‡¥ø", "‡¥ï‡µä‡¥≥‡µã‡¥∏‡µã‡¥∏‡µç", "1 ‡¥§‡µÜ‡¥∏‡¥≤‡µã‡¥®‡¥ø‡¥ï‡µç‡¥ï‡¥æ", "2 ‡¥§‡µÜ‡¥∏‡¥≤‡µã‡¥®‡¥ø‡¥ï‡µç‡¥ï‡¥æ",
      "1 ‡¥§‡¥ø‡¥Æ‡µã‡¥§‡µç‡¥§‡µá‡¥Ø‡µã‡¥∏‡µç", "2 ‡¥§‡¥ø‡¥Æ‡µã‡¥§‡µç‡¥§‡µá‡¥Ø‡µã‡¥∏‡µç", "‡¥§‡µÄ‡¥§‡µç‡¥§‡µã‡¥∏‡µç","****", "‡¥´‡¥ø‡¥≤‡µÜ‡¥Æ‡µã‚Äå‡¥®‡µç‚Äç",
      "‡¥π‡µÜ‡¥¨‡µç‡¥∞‡¥æ‡¥Ø‡¥∞‡µç‚Äç", "‡¥Ø‡¥æ‡¥ï‡µç‡¥ï‡µã‡¥¨‡µç", "1 ‡¥™‡¥§‡µç‡¥∞‡µã‡¥∏‡µç", "2 ‡¥™‡¥§‡µç‡¥∞‡µã‡¥∏‡µç", "1 ‡¥Ø‡µã‡¥π‡¥®‡µç‡¥®‡¥æ‚Äå‡¥®‡µç‚Äç",
      "2 ‡¥Ø‡µã‡¥π‡¥®‡µç‡¥®‡¥æ‚Äå‡¥®‡µç‚Äç", "3 ‡¥Ø‡µã‡¥π‡¥®‡µç‡¥®‡¥æ‚Äå‡¥®‡µç‚Äç", "‡¥Ø‡µÅ‡¥¶‡¥æ‡¥∏‡µç", "****","‡¥µ‡µÜ‡¥≥‡¥ø‡¥™‡¥æ‡¥ü‡µç"
    ];

    let DATA = [];           // full rows with Book/Chapter/Verse/Text
    let currentIndex = -1;   // pointer into DATA

    // ===== UI Elements =====
    const booksEl = document.getElementById('books');
    const chaptersEl = document.getElementById('chapters');
    const versesEl = document.getElementById('verses');
    const refEl = document.getElementById('ref');
    const verseEl = document.getElementById('verse');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const openPresentationBtn = document.getElementById('openPresentationBtn');

    // ===== CSV Loading =====
    async function loadCSV() {
      // Expect verses.csv next to index.html
      const url = new URL('verses.csv', location.href).href;
      return new Promise((resolve, reject) => {
        Papa.parse(url, {
          download: true,
          header: true,
          skipEmptyLines: true,
          complete: (res) => resolve(res.data),
          error: reject,
          encoding: 'utf-8'
        });
      });
    }

    function parseTitle(row) {
      const title = (row['Title'] || '').trim();
      if (!title.includes(':')) return { Book: '', Chapter: '', Verse: '' };
      const lastColon = title.lastIndexOf(':');
      const left = title.slice(0, lastColon).trim();
      const verse = title.slice(lastColon + 1).trim();
      const leftParts = left.split(/\s+(?=[^\s]+$)/); // split on last space
      const book = leftParts.length === 2 ? leftParts[0].trim() : '';
      const chapter = leftParts.length === 2 ? leftParts[1].trim() : '';
      return { Book: book, Chapter: chapter, Verse: verse };
    }

    function enrichAndSort(raw) {
      const rows = raw.map(r => {
        const x = { ...r };
        const parts = parseTitle(r);
        x.Book = parts.Book; x.Chapter = parts.Chapter; x.Verse = parts.Verse;
        x.Text = r['Text'] || '';
        return x;
      });
      rows.sort((a, b) => {
        const k1 = normalizeText(a.Book).localeCompare(normalizeText(b.Book));
        if (k1 !== 0) return k1;
        const c = safeInt(a.Chapter) - safeInt(b.Chapter);
        if (c !== 0) return c;
        return safeInt(a.Verse) - safeInt(b.Verse);
      });
      return rows;
    }

    // ===== Rendering =====
    function clear(el) { el.innerHTML = ''; }

    function renderBooks() {
      clear(booksEl);
      BOOKS.forEach(book => {
        if (book === '****') {
          const sep = document.createElement('div'); sep.className = 'chip sep'; booksEl.appendChild(sep); return;
        }
        const btn = document.createElement('button');
        btn.className = 'chip';
        btn.textContent = book;
        btn.addEventListener('click', () => selectBook(book));
        btn.setAttribute('role', 'option');
        booksEl.appendChild(btn);
      });
    }

    function selectBook(book) {
      state.book = book; state.chapter = ''; state.verse = '';
      highlightActive(booksEl, book);
      renderChapters(book);
      clear(versesEl);
      updateViewer();
    }

    function renderChapters(book) {
      clear(chaptersEl);
      const chapters = uniqueOrdered(
        DATA.filter(r => normalizeText(r.Book) === normalizeText(book)).map(r => r.Chapter).filter(Boolean)
      );
      chapters.forEach(ch => {
        const b = document.createElement('button');
        b.className = 'tiny-btn'; b.textContent = ch;
        b.addEventListener('click', () => selectChapter(ch));
        chaptersEl.appendChild(b);
      });
    }

    function selectChapter(chapter) {
      state.chapter = chapter; state.verse = '';
      highlightActive(chaptersEl, chapter);
      renderVerses(state.book, chapter);
      updateViewer();
    }

    function renderVerses(book, chapter) {
      clear(versesEl);
      const verses = uniqueOrdered(
        DATA.filter(r => normalizeText(r.Book) === normalizeText(book) && normalizeText(r.Chapter) === normalizeText(chapter)).map(r => r.Verse).filter(Boolean)
      );
      verses.forEach(v => {
        const b = document.createElement('button');
        b.className = 'tiny-btn'; b.textContent = v;
        b.addEventListener('click', () => selectVerse(v));
        versesEl.appendChild(b);
      });
    }

    function selectVerse(verse) {
      state.verse = verse;
      highlightActive(versesEl, verse);
      // set currentIndex
      currentIndex = DATA.findIndex(r =>
        normalizeText(r.Book) === normalizeText(state.book) && normalizeText(r.Chapter) === normalizeText(state.chapter) && normalizeText(r.Verse) === normalizeText(state.verse)
      );
      updateViewer();
    }

    function updateViewer() {
      if (state.book && state.chapter && state.verse) {
        const row = DATA[currentIndex] || DATA.find(r => normalizeText(r.Book) === normalizeText(state.book) && normalizeText(r.Chapter) === normalizeText(state.chapter) && normalizeText(r.Verse) === normalizeText(state.verse));
        if (row) {
          refEl.textContent = `${row.Book} ${row.Chapter}:${row.Verse}`;
          verseEl.textContent = row.Text || '';
          syncPresentation(); // keep presentation window updated
          return;
        }
      }
      refEl.textContent = '\u00A0';
      verseEl.textContent = '‡¥µ‡¥ö‡¥®‡¥Ç ‡¥§‡¥ø‡¥∞‡¥û‡µç‡¥û‡µÜ‡¥ü‡µÅ‡¥ï‡µç‡¥ï‡µÅ‡¥ï (Select a verse)';
      syncPresentation(); // clear presentation too
    }

    function highlightActive(container, value) {
      [...container.children].forEach(el => {
        if (!el.classList.contains('chip') && !el.classList.contains('tiny-btn')) return;
        el.classList.toggle('active', el.textContent.trim() === String(value).trim());
      });
    }

    // ===== Navigation =====
    function nextVerse() {
      if (currentIndex < 0) return; if (currentIndex >= DATA.length - 1) return;
      currentIndex += 1; jumpToIndex(currentIndex);
    }
    function prevVerse() {
      if (currentIndex <= 0) return; currentIndex -= 1; jumpToIndex(currentIndex);
    }
    function jumpToIndex(i) {
      const row = DATA[i]; if (!row) return;
      state.book = row.Book; state.chapter = row.Chapter; state.verse = row.Verse;
      highlightActive(booksEl, row.Book);
      renderChapters(row.Book);
      highlightActive(chaptersEl, row.Chapter);
      renderVerses(row.Book, row.Chapter);
      highlightActive(versesEl, row.Verse);
      updateViewer();
    }

    // Keyboard bindings (works on macOS/iPad hardware keyboards too)
    window.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowLeft') { prevVerse(); e.preventDefault(); }
      if (e.key === 'ArrowRight') { nextVerse(); e.preventDefault(); }
      if (e.key.toLowerCase() === 'p') { openPresentation(); e.preventDefault(); }
      if (e.metaKey && e.key === 'ArrowLeft') { prevVerse(); e.preventDefault(); }
      if (e.metaKey && e.key === 'ArrowRight') { nextVerse(); e.preventDefault(); }
    });

    prevBtn.addEventListener('click', prevVerse);
    nextBtn.addEventListener('click', nextVerse);

    const state = { book: '', chapter: '', verse: '' };

    // ===== Presentation Window =====
    let presWin = null;
    function openPresentation() {
      // Reuse if already open
      if (!presWin || presWin.closed) {
        presWin = window.open('', 'verse_presentation', 'width=1200,height=800');
        if (!presWin) {
          alert('Please allow pop-ups to use Presentation Mode.');
          return;
        }
        // Write minimal HTML into the new window
        presWin.document.write(`
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Presentation</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Malayalam:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #000814; --text: #e8ecff; --muted: #9fb0ff;
      --btn: #1c2752; --btn-hover:#253163; --border:#1d2750;
    }
    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--text);
      font-family: "Noto Sans Malayalam", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    .stage { display:flex; flex-direction:column; height:100%; }
    .ref { text-align:center; font-weight:700; font-size: clamp(16px, 2.2vw, 28px); color: var(--muted);
      padding: 10px 12px; border-bottom: 1px solid #0c1230; }
    .verse { flex:1; display:flex; align-items:center; justify-content:center; padding: 4vh 5vw;
      font-weight:700; font-size: clamp(36px, 7.5vw, 96px); line-height:1.25; text-align:center; white-space:pre-wrap; }
    .controls { display:flex; gap:12px; justify-content:center; padding: 14px; border-top: 1px solid #0c1230; flex-wrap: wrap; }
    .btn { background: var(--btn); border:1px solid var(--border); color: var(--text); padding: 12px 16px; border-radius: 14px; font-size:16px; cursor:pointer; }
    .btn:hover { background: var(--btn-hover); }
  </style>
</head>
<body>
  <div class="stage">
    <div id="ref" class="ref">&nbsp;</div>
    <div id="verse" class="verse">‡¥µ‡¥ö‡¥®‡¥æ‡¥µ‡¥§‡¥∞‡¥£‡¥Ç (Presentation)</div>
    <div class="controls">
      <button class="btn" id="prev">‚Üê Previous</button>
      <button class="btn" id="next">Next ‚Üí</button>
      <button class="btn" id="fs">‚õ∂ Full Screen</button>
    </div>
  </div>
  <script>
    // receive updates from opener
    window.addEventListener('message', (ev) => {
      if (!ev.data || ev.data.type !== 'VERSE_UPDATE') return;
      const { ref, text } = ev.data.payload || {};
      document.getElementById('ref').textContent = ref || '\\u00A0';
      document.getElementById('verse').textContent = text || '';
    });

    // navigation buttons & keys -> request nav on opener
    function nav(dir) { if (window.opener && !window.opener.closed) window.opener.postMessage({ type:'NAV', payload:{ dir } }, '*'); }

    document.getElementById('prev').addEventListener('click', () => nav('prev'));
    document.getElementById('next').addEventListener('click', () => nav('next'));

    document.getElementById('fs').addEventListener('click', async () => {
      try {
        if (!document.fullscreenElement) { await document.documentElement.requestFullscreen(); }
        else { await document.exitFullscreen(); }
      } catch (e) { console.warn(e); }
    });

    window.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowLeft') { nav('prev'); e.preventDefault(); }
      if (e.key === 'ArrowRight') { nav('next'); e.preventDefault(); }
    });
  </script>
</body>
</html>`);
        presWin.document.close();
      }
      // push current verse immediately
      syncPresentation();
      try { presWin.focus(); } catch (e) {}
    }

    function syncPresentation() {
      if (!presWin || presWin.closed) return;
      const ref = refEl.textContent || '';
      const text = verseEl.textContent || '';
      presWin.postMessage({ type: 'VERSE_UPDATE', payload: { ref, text } }, '*');
    }

    // Receive nav requests coming from presentation window
    window.addEventListener('message', (ev) => {
      if (!ev.data) return;
      if (ev.data.type === 'NAV') {
        const dir = (ev.data.payload && ev.data.payload.dir) || '';
        if (dir === 'prev') prevVerse();
        if (dir === 'next') nextVerse();
      }
    });

    openPresentationBtn.addEventListener('click', openPresentation);

    // ===== Boot =====
    (async function init() {
      try {
        const raw = await loadCSV();
        DATA = enrichAndSort(raw);
        renderBooks();
        // Optionally auto-select first verse:
        // currentIndex = 0; jumpToIndex(0);
      } catch (err) {
        verseEl.textContent = 'Failed to load verses.csv. Place it next to index.html in your repository.';
        console.error(err);
      }
    })();
  </script>
</body>
</html>
