<!doctype html>
<html lang="ml">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bible Verse Navigator</title>

  <!-- Malayalam font for verse rendering later; UI uses system font -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Malayalam:wght@400;700&display=swap" rel="stylesheet">

  <style>
    /* Light, simple, ttk-like look to match your screenshot */
    :root {
      --bg: #f5f6f7;
      --panel: #ffffff;
      --border: #d6d8db;
      --text: #111827;
      --muted: #6b7280;
      --btn-bg: #ffffff;
      --btn-border: #c9ccd1;
      --btn-hover: #f0f2f5;
    }
    * { box-sizing: border-box; }
    html, body { margin: 0; background: var(--bg); color: var(--text); }
    header {
      display: flex; align-items: center; gap: 10px;
      padding: 10px 14px; border-bottom: 1px solid var(--border);
      background: linear-gradient(#fff, #fafbfc);
      position: sticky; top: 0; z-index: 1;
    }
    header h1 { margin: 0; font-size: 16px; font-weight: 700; }
    .wrap { max-width: 1200px; margin: 12px auto; padding: 0 12px 24px; }

    /* Fieldset-style blocks to mimic ttk LabelFrame */
    .group {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 6px;
      margin: 10px 0;
      padding: 14px;
      position: relative;
    }
    .group > .legend {
      position: absolute; top: -10px; left: 10px;
      background: var(--bg);
      padding: 0 6px;
      font-size: 12px; color: var(--muted);
      border: 1px solid var(--border);
      border-radius: 10px;
      line-height: 18px;
    }

    .grid-books {
      display: grid;
      /* many columns like your screenshot; they’ll wrap nicely */
      grid-template-columns: repeat(9, minmax(130px, 1fr));
      gap: 8px;
    }
    @media (max-width: 1200px) {
      .grid-books { grid-template-columns: repeat(6, minmax(130px, 1fr)); }
    }
    @media (max-width: 800px) {
      .grid-books { grid-template-columns: repeat(3, minmax(120px, 1fr)); }
    }
    .grid-tight { display: grid; grid-template-columns: repeat(auto-fill, minmax(44px, 1fr)); gap: 8px; }

    .btn {
      display: inline-flex; align-items: center; justify-content: center;
      background: var(--btn-bg);
      border: 1px solid var(--btn-border);
      border-radius: 6px;
      padding: 6px 10px;
      min-height: 30px; min-width: 38px;
      cursor: pointer; user-select: none;
      font-size: 14px;
    }
    .btn:hover { background: var(--btn-hover); }
    .btn[disabled] { opacity: .6; cursor: not-allowed; }
    .divider {
      grid-column: 1 / -1;
      height: 1px;
      background: var(--border);
      margin: 2px 0;
    }
    .hint { font-size: 12px; color: var(--muted); margin-top: 6px; }
  </style>
</head>
<body>
  <header>
    <h1>Bible Verse Navigator</h1>
  </header>

  <div class="wrap">
    <section class="group">
      <div class="legend">Books</div>
      <div id="books" class="grid-books"></div>
    </section>

    <section class="group">
      <div class="legend">Chapters</div>
      <div id="chapters" class="grid-tight"></div>
    </section>

    <section class="group">
      <div class="legend">Verses</div>
      <div id="verses" class="grid-tight"></div>
    </section>

    <p class="hint">After opening a verse, use ← / → to navigate. Use the Full Screen button; press ESC to exit.</p>
  </div>

  <script>
    // ---- Utilities ----
    const normalizeText = s => (s ?? "").normalize("NFKC").replace(/\u200d/g,"").replace(/\u00A0/g," ").trim();
    const num = s => { const n = parseInt(s, 10); return Number.isFinite(n) ? n : -1; };
    const unique = (arr) => { const seen = new Set(); const out=[]; for (const x of arr){ if(!seen.has(x)){ seen.add(x); out.push(x); } } return out; };

    // Book list with separators "****" (we only use it to render buttons in your order)
    const BOOKS = [
      "ഉല്‍‍പത്തി","പുറപ്പാട്","ലേവ്യര്‍","സംഖ്യ","നിയമാവര്‍ത്തനം",
      "ജോഷ്വാ","ന്യായാധിപ‌ന്‍മാര്‍","റൂത്ത്",
      "1 സാമുവല്‍","2 സാമുവല്‍","****","1 രാജാക്ക‌ന്‍മാര്‍","2 രാജാക്ക‌ന്‍മാര്‍",
      "1 ദിനവൃത്താന്തം","2 ദിനവൃത്താന്തം","എസ്രാ","നെഹമിയ","തോബിത്",
      "യൂദിത്ത്","എസ്തേര്‍","1 മക്കബായര്‍","2 മക്കബായര്‍","ജോബ്","****",
      "സങ്കീര്‍ത്തനങ്ങള്‍","സുഭാഷിതങ്ങള്‍","സഭാപ്രസംഗക‌ന്‍","****","ഉത്തമഗീതം",
      "ജ്ഞാനം","പ്രഭാഷക‌ന്‍","ഏശയ്യാ","ജെറെമിയ","വിലാപങ്ങള്‍","ബാറൂക്ക്",
      "എസെക്കിയേല്‍","ദാനിയേല്‍","****","ഹോസിയാ","ജോയേല്‍","ആമോസ്","ഒബാദിയ",
      "യോനാ","മിക്കാ","നാഹും","ഹബക്കുക്ക്","സെഫാനിയ","ഹഗ്ഗായി",
      "സഖറിയാ","മലാക്കി","****","മത്തായി","മര്‍ക്കോസ്","ലൂക്കാ","യോഹന്നാ‌ന്‍",
      "അപ്പ. പ്രവര്‍ത്തനങ്ങള്‍","****","റോമാ","1 കൊറിന്തോസ്","2 കൊറിന്തോസ്","ഗലാത്തിയാ",
      "എഫേസോസ്","ഫിലിപ്പി","കൊളോസോസ്","1 തെസലോനിക്കാ","2 തെസലോനിക്കാ",
      "1 തിമോത്തേയോസ്","2 തിമോത്തേയോസ്","തീത്തോസ്","****","ഫിലെമോ‌ന്‍",
      "ഹെബ്രായര്‍","യാക്കോബ്","1 പത്രോസ്","2 പത്രോസ്","1 യോഹന്നാ‌ന്‍",
      "2 യോഹന്നാ‌ന്‍","3 യോഹന്നാ‌ന്‍","യുദാസ്","****","വെളിപാട്"
    ];

    // ---- State ----
    let ALL_ROWS = []; // full CSV (as-is)
    let currentBook = "", currentChapter = "";

    // ---- CSV parser (handles quotes/commas) ----
    function parseCSV(text) {
      const rows = [];
      let row = [], field = "", q = false;
      for (let i=0;i<text.length;i++){
        const c=text[i], n=text[i+1];
        if(q){
          if(c==='"' && n === '"'){ field+='"'; i++; }
          else if(c === '"'){ q=false; }
          else { field+=c; }
        }else{
          if(c === '"'){ q = true; }
          else if(c === ','){ row.push(field); field=""; }
          else if(c === '\n'){ row.push(field); rows.push(row); row=[]; field=""; }
          else if(c === '\r'){ /* ignore */ }
          else { field += c; }
        }
      }
      if(field.length || row.length){ row.push(field); rows.push(row); }
      const header = rows.shift() || [];
      return rows.map(r => Object.fromEntries(header.map((h,i)=>[h, r[i] ?? ""])));
    }

    // ---- Load data ----
    async function loadData() {
      const res = await fetch("verses.csv", { cache: "no-store" });
      if (!res.ok) { alert("verses.csv not found"); return; }
      const raw = await res.text();
      const rows = parseCSV(raw);

      // Normalize & fill Book/Chapter/Verse from Title if missing
      for (const r of rows){
        const t = normalizeText(r.Title);
        if (t && t.includes(":")){
          const [left, v] = t.split(":");
          const leftParts = normalizeText(left).split(" ");
          const ch = leftParts.pop() ?? "";
          const b  = leftParts.join(" ");
          r.Book    = normalizeText(r.Book || b);
          r.Chapter = normalizeText(r.Chapter || ch);
          r.Verse   = normalizeText(r.Verse || v);
        } else {
          r.Book    = normalizeText(r.Book);
          r.Chapter = normalizeText(r.Chapter);
          r.Verse   = normalizeText(r.Verse);
        }
        r.Text = r.Text ?? "";
      }
      ALL_ROWS = rows.filter(r => r.Book && r.Chapter && r.Verse);

      renderBooks();
    }

    // ---- Render Books / Chapters / Verses ----
    const booksEl = document.getElementById("books");
    const chaptersEl = document.getElementById("chapters");
    const versesEl = document.getElementById("verses");

    function renderBooks(){
      booksEl.innerHTML = "";
      BOOKS.forEach(name => {
        if (name === "****"){
          const hr = document.createElement("div");
          hr.className = "divider";
          booksEl.appendChild(hr);
        } else {
          const b = document.createElement("button");
          b.className = "btn";
          b.textContent = name;
          b.onclick = () => selectBook(name);
          booksEl.appendChild(b);
        }
      });
    }

    function selectBook(book){
      currentBook = book;
      currentChapter = "";
      // Chapters from rows of this book; sort numerically to look tidy like screenshot
      const chapters = unique(
        ALL_ROWS.filter(r => normalizeText(r.Book) === normalizeText(book))
                .map(r => r.Chapter)
      ).sort((a,b)=> num(a)-num(b));

      chaptersEl.innerHTML = "";
      versesEl.innerHTML = "";
      for (const ch of chapters){
        if(!ch) continue;
        const btn = document.createElement("button");
        btn.className = "btn";
        btn.textContent = ch;
        btn.onclick = () => selectChapter(ch);
        chaptersEl.appendChild(btn);
      }
    }

    function selectChapter(chapter){
      currentChapter = chapter;
      const verses = unique(
        ALL_ROWS.filter(r =>
          normalizeText(r.Book) === normalizeText(currentBook) &&
          normalizeText(r.Chapter) === normalizeText(chapter)
        ).map(r => r.Verse)
      ).sort((a,b)=> num(a)-num(b));

      versesEl.innerHTML = "";
      for (const v of verses){
        if(!v) continue;
        const btn = document.createElement("button");
        btn.className = "btn";
        btn.textContent = v;
        btn.onclick = () => openPresentation(currentBook, currentChapter, v);
        versesEl.appendChild(btn);
      }
    }

    function openPresentation(book, chapter, verse){
      const url = new URL("presentation.html", location.href);
      url.searchParams.set("book", book);
      url.searchParams.set("chapter", chapter);
      url.searchParams.set("verse", verse);
      window.open(url.toString(), "_blank", "noopener,noreferrer");
    }

    loadData();
  </script>
</body>
</html>
