<!doctype html>
<html lang="ml">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bible Verse Navigator</title>

  <!-- Malayalam font (also used by presentation) -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Malayalam:wght@400;700&display=swap" rel="stylesheet">

  <style>
    /* Dark theme to match presentation.html */
    :root{
      --bg:#0b1324;
      --panel:#0e172b;
      --border:#22335a;
      --text:#f5f7fb;
      --muted:#9aa4b2;
      --btn-bg:#0e1527;
      --btn-hover:#101a33;
      --btn-border:#22335a;
      --accent:#0ea5e9;
    }
    *{ box-sizing:border-box; }
    html,body{ margin:0; background:var(--bg); color:var(--text);
      font-family:"Noto Sans Malayalam", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }

    header{
      display:flex; align-items:center; gap:10px;
      padding:12px 16px; position:sticky; top:0; z-index:2;
      background:rgba(8,12,24,.7); backdrop-filter:blur(6px);
      border-bottom:1px solid var(--border);
    }
    header h1{ margin:0; font-size:16px; font-weight:700; letter-spacing:.2px; }

    .wrap{ max-width:1280px; margin:14px auto 32px; padding:0 14px; }

    /* LabelFrame-style groups */
    .group{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:12px;
      margin:12px 0;
      padding:16px 14px 14px;
      position:relative;
      box-shadow:0 10px 28px rgba(0,0,0,.35);
    }
    .legend{
      position:absolute; top:-10px; left:12px;
      font-size:12px; color:var(--muted); letter-spacing:.2px;
      background:var(--bg);
      padding:0 8px; border:1px solid var(--border); border-radius:999px;
      line-height:20px;
    }

    /* Layout grids */
    .grid-books{
      display:grid;
      /* smaller min width = more items per row */
      grid-template-columns: repeat(12, minmax(100px, 1fr));
      gap:6px;
    }
    @media (max-width:1200px){ .grid-books{ grid-template-columns: repeat(9, minmax(96px,1fr)); } }
    @media (max-width:900px){  .grid-books{ grid-template-columns: repeat(6, minmax(92px,1fr)); } }
    @media (max-width:640px){  .grid-books{ grid-template-columns: repeat(3, minmax(90px,1fr)); } }

    .grid-tight{ display:grid; grid-template-columns: repeat(auto-fill, minmax(42px, 1fr)); gap:6px; }

    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      background:var(--btn-bg); color:var(--text);
      border:1px solid var(--btn-border); border-radius:8px;
      padding:4px 8px;
      min-height:28px; min-width:36px;
      font-size:12px; font-weight:700; letter-spacing:.1px;
      cursor:pointer; user-select:none;
      transition:background .15s ease, border-color .15s ease, transform .03s ease;
      text-align:center;
    }
    .btn:hover{ background:var(--btn-hover); border-color:#2b4271; }
    .btn:active{ transform:translateY(1px); }
    .btn[disabled]{ opacity:.55; cursor:not-allowed; }

    /* Visual divider for "****" in book list */
    .divider{
      grid-column:1 / -1;
      height:1px; background:linear-gradient(90deg, transparent, var(--border), transparent);
      margin:2px 0 6px;
    }

    .hint{ color:var(--muted); font-size:12px; margin-top:10px; }
  </style>
</head>
<body>
  <header>
    <h1>Bible Verse Navigator</h1>
  </header>

  <div class="wrap">
    <section class="group">
      <div class="legend">Books</div>
      <div id="books" class="grid-books"></div>
    </section>

    <section class="group">
      <div class="legend">Chapters</div>
      <div id="chapters" class="grid-tight"></div>
    </section>

    <section class="group">
      <div class="legend">Verses</div>
      <div id="verses" class="grid-tight"></div>
    </section>

    <p class="hint">Open a verse to launch the presentation window. Use ← / → to navigate and the Full Screen button (ESC to exit).</p>
  </div>

  <script>
    // ---------- Utilities ----------
    const norm = s => (s ?? "").normalize("NFKC").replace(/\u200d/g,"").replace(/\u00A0/g," ").trim();
    const toNum = s => { const n = parseInt(s,10); return Number.isFinite(n) ? n : -1; };
    const unique = arr => { const seen=new Set(); const out=[]; for(const x of arr){ if(!seen.has(x)){ seen.add(x); out.push(x);} } return out; };

    // Custom book order (+ separators as "****")
    const BOOKS = [
      "ഉല്‍‍പത്തി","പുറപ്പാട്","ലേവ്യര്‍","സംഖ്യ","നിയ",
      "ജോഷ്വാ","ന്യായാ","റൂത്ത്",
      "1 സാമുവല്‍","2 സാമുവല്‍","****","1 രാജാ","2 രാജാ",
      "1 ദിന","2 ദിന","എസ്രാ","നെഹമിയ","തോബിത്",
      "യൂദിത്ത്","എസ്തേര്‍","1 മക്കബായര്‍","2 മക്കബായര്‍","ജോബ്","****",
      "സങ്കീ","സുഭ","സഭാ","****","ഉത്തമഗീതം",
      "ജ്ഞാനം","പ്രഭാഷക‌ന്‍","ഏശയ്യാ","ജെറെമിയ","വിലാപങ്ങള്‍","ബാറൂക്ക്",
      "എസെക്കി","ദാനിയേല്‍","****","ഹോസിയാ","ജോയേല്‍","ആമോസ്","ഒബാദിയ",
      "യോനാ","മിക്കാ","നാഹും","ഹബക്കുക്ക്","സെഫാനിയ","ഹഗ്ഗായി",
      "സഖറിയാ","മലാക്കി","****","മത്തായി","മര്‍ക്കോസ്","ലൂക്കാ","യോഹന്നാ‌ന്‍",
      "അപ്പ.","****","റോമാ","1 കൊറി","2 കൊറി","ഗലാത്തിയാ",
      "എഫേ","ഫിലിപ്പി","കൊളോ","1 തെസ","2 തെസ",
      "1 തിമോ","2 തിമോ","തീത്തോസ്","****","ഫിലെമോ‌ന്‍",
      "ഹെബ്രായര്‍","യാക്കോബ്","1 പത്രോസ്","2 പത്രോസ്","1 യോഹന്നാ‌ന്‍",
      "2 യോഹന്നാ‌ന്‍","3 യോഹന്നാ‌ന്‍","യുദാസ്","****","വെളിപാട്"
    ];

    // ---------- State ----------
    let ALL_ROWS = []; // CSV rows, as-is (we don't re-order)

    // ---------- CSV parser (robust to quotes/commas) ----------
    function parseCSV(text){
      const rows=[]; let row=[], field="", inQ=false;
      for (let i=0;i<text.length;i++){
        const c=text[i], n=text[i+1];
        if(inQ){
          if(c==='"' && n === '"'){ field+='"'; i++; }
          else if(c==='"'){ inQ=false; }
          else { field+=c; }
        }else{
          if(c==='"'){ inQ=true; }
          else if(c===','){ row.push(field); field=""; }
          else if(c==='\n'){ row.push(field); rows.push(row); row=[]; field=""; }
          else if(c==='\r'){ /* ignore */ }
          else { field+=c; }
        }
      }
      if(field.length || row.length){ row.push(field); rows.push(row); }
      const header = rows.shift() || [];
      return rows.map(r => Object.fromEntries(header.map((h,i)=>[h, r[i] ?? ""])));
    }

    // ---------- Load CSV ----------
    async function loadData(){
      const res = await fetch("verses.csv", { cache:"no-store" });
      if(!res.ok){ alert("verses.csv not found"); return; }
      const raw = await res.text();
      const rows = parseCSV(raw);

      // Normalize & infer B/C/V from Title when needed
      for (const r of rows){
        const t = norm(r.Title);
        if (t && t.includes(":")){
          const [left, v] = t.split(":");
          const parts = norm(left).split(" ");
          const ch = parts.pop() ?? "";
          const b  = parts.join(" ");
          r.Book    = norm(r.Book || b);
          r.Chapter = norm(r.Chapter || ch);
          r.Verse   = norm(r.Verse || v);
        } else {
          r.Book    = norm(r.Book);
          r.Chapter = norm(r.Chapter);
          r.Verse   = norm(r.Verse);
        }
        r.Text = r.Text ?? "";
      }
      ALL_ROWS = rows.filter(r => r.Book && r.Chapter && r.Verse);

      renderBooks();
    }

    // ---------- Renderers ----------
    const booksEl = document.getElementById("books");
    const chaptersEl = document.getElementById("chapters");
    const versesEl = document.getElementById("verses");

    function renderBooks(){
      booksEl.innerHTML = "";
      BOOKS.forEach(name=>{
        if(name==="****"){
          const d=document.createElement("div"); d.className="divider"; booksEl.appendChild(d);
        }else{
          const b=document.createElement("button");
          b.className="btn"; b.textContent=name;
          b.onclick=()=>selectBook(name);
          booksEl.appendChild(b);
        }
      });
    }

    function selectBook(book){
      // Chapters that actually appear in CSV for this book
      const chapters = unique(
        ALL_ROWS.filter(r => norm(r.Book) === norm(book)).map(r => r.Chapter)
      ).sort((a,b)=>toNum(a)-toNum(b));

      chaptersEl.innerHTML=""; versesEl.innerHTML="";
      for(const ch of chapters){
        if(!ch) continue;
        const btn=document.createElement("button");
        btn.className="btn"; btn.textContent=ch;
        btn.onclick=()=>selectChapter(book, ch);
        chaptersEl.appendChild(btn);
      }
    }

    function selectChapter(book, chapter){
      const verses = unique(
        ALL_ROWS.filter(r => norm(r.Book)===norm(book) && norm(r.Chapter)===norm(chapter))
                .map(r => r.Verse)
      ).sort((a,b)=>toNum(a)-toNum(b));

      versesEl.innerHTML="";
      for(const v of verses){
        if(!v) continue;
        const btn=document.createElement("button");
        btn.className="btn"; btn.textContent=v;
        btn.onclick=()=>openPresentation(book, chapter, v);
        versesEl.appendChild(btn);
      }
    }

    function openPresentation(book, chapter, verse){
      const url = new URL("presentation.html", location.href);
      url.searchParams.set("book", book);
      url.searchParams.set("chapter", chapter);
      url.searchParams.set("verse", verse);
      window.open(url.toString(), "_blank", "noopener,noreferrer");
    }

    // ---------- Start ----------
    loadData();
  </script>
</body>
</html>
