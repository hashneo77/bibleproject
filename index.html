<!doctype html>
<html lang="ml">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bible Verse Navigator (Web)</title>

  <!-- Malayalam font -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Malayalam:wght@400;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --accent: #0f766e;
      --bg: #0b1324;
      --panel: #121a2b;
      --muted: #9aa4b2;
      --text: #e5e7eb;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Noto Sans Malayalam", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      background: radial-gradient(1200px 700px at 20% -10%, #1a2440 0%, var(--bg) 40%);
      min-height: 100vh;
    }
    header {
      padding: 16px 20px;
      border-bottom: 1px solid #1f2a44;
      position: sticky; top: 0; background: rgba(11,19,36,0.75); backdrop-filter: blur(6px);
    }
    h1 { margin: 0; font-weight: 700; letter-spacing: .2px; }
    .container { padding: 18px 20px 40px; max-width: 1400px; margin: 0 auto; }
    .grid {
      display: grid;
      grid-template-columns: 1.1fr .9fr .9fr;
      gap: 14px;
    }
    @media (max-width: 1024px) {
      .grid { grid-template-columns: 1fr; }
    }
    .card {
      background: var(--panel);
      border: 1px solid #1f2a44;
      border-radius: 16px;
      padding: 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .card h2 {
      margin: 2px 0 12px;
      font-size: 18px;
      color: #cfe1ff;
      letter-spacing: .2px;
      font-weight: 700;
    }
    .btn {
      display: inline-flex; align-items: center; justify-content: center;
      padding: 8px 12px; border-radius: 10px; border: 1px solid #2a395f;
      background: #0e1527; color: var(--text); cursor: pointer; user-select: none;
      font-weight: 600; transition: transform .03s ease, background .15s ease, border-color .15s ease;
      min-width: 44px;
    }
    .btn:hover { background: #101a33; border-color: #36508c; }
    .btn:active { transform: translateY(1px); }
    .btn[disabled] { opacity: .5; cursor: not-allowed; }
    .chips { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 8px; }
    .chips.tight { grid-template-columns: repeat(auto-fill, minmax(52px, 1fr)); gap: 8px; }
    .chips.tighter { grid-template-columns: repeat(auto-fill, minmax(46px, 1fr)); gap: 8px; }
    .divider {
      height: 1px; background: linear-gradient(90deg, transparent, #24345c, transparent);
      margin: 10px 0;
    }
    .nt-tag { margin: 8px 0 4px; color: var(--muted); font-size: 12px; }
    .footer-note { color: var(--muted); font-size: 12px; margin-top: 14px; }
  </style>
</head>
<body>
  <header>
    <h1>Bible Verse Navigator</h1>
  </header>

  <div class="container">
    <div class="grid">
      <section class="card" id="books-card">
        <h2>Books</h2>
        <div class="chips" id="books"></div>
        <div class="nt-tag" id="ntMarker" style="display:none;">— New Testament —</div>
      </section>

      <section class="card">
        <h2>Chapters</h2>
        <div class="chips tight" id="chapters"></div>
      </section>

      <section class="card">
        <h2>Verses</h2>
        <div class="chips tighter" id="verses"></div>
      </section>
    </div>

    <p class="footer-note">Tip: After opening a verse, use your keyboard ← / → to move between verses. Press the Full Screen button (ESC to exit).</p>
  </div>

  <script>
    // ---- Utility functions (normalize & safe int) ----
    const normalizeText = s => (s ?? "").normalize("NFKC").replace(/\u200d/g,"").replace(/\u00A0/g," ").trim();
    const safeInt = s => { const n = parseInt(s, 10); return Number.isFinite(n) ? n : -1; };

    // ---- Book order (with separators represented by "****") ----
    const BOOKS = [
      "ഉല്‍‍പത്തി","പുറപ്പാട്","ലേവ്യര്‍","സംഖ്യ","നിയമാവര്‍ത്തനം",
      "ജോഷ്വാ","ന്യായാധിപ‌ന്‍മാര്‍","റൂത്ത്",
      "1 സാമുവല്‍","2 സാമുവല്‍","****","1 രാജാക്ക‌ന്‍മാര്‍","2 രാജാക്ക‌ന്‍മാര്‍",
      "1 ദിനവൃത്താന്തം","2 ദിനവൃത്താന്തം","എസ്രാ","നെഹമിയ","തോബിത്",
      "യൂദിത്ത്","എസ്തേര്‍","1 മക്കബായര്‍","2 മക്കബായര്‍","ജോബ്","****",
      "സങ്കീര്‍ത്തനങ്ങള്‍","സുഭാഷിതങ്ങള്‍","സഭാപ്രസംഗക‌ന്‍","****","ഉത്തമഗീതം",
      "ജ്ഞാനം","പ്രഭാഷക‌ന്‍","ഏശയ്യാ","ജെറെമിയ","വിലാപങ്ങള്‍","ബാറൂക്ക്",
      "എസെക്കിയേല്‍","ദാനിയേല്‍","****","ഹോസിയാ","ജോയേല്‍","ആമോസ്","ഒബാദിയ",
      "യോനാ","മിക്കാ","നാഹും","ഹബക്കുക്ക്","സെഫാനിയ","ഹഗ്ഗായി",
      "സഖറിയാ","മലാക്കി","****","മത്തായി","മര്‍ക്കോസ്","ലൂക്കാ","യോഹന്നാ‌ന്‍",
      "അപ്പ. പ്രവര്‍ത്തനങ്ങള്‍","****","റോമാ","1 കൊറിന്തോസ്","2 കൊറിന്തോസ്","ഗലാത്തിയാ",
      "എഫേസോസ്","ഫിലിപ്പി","കൊളോസോസ്","1 തെസലോനിക്കാ","2 തെസലോനിക്കാ",
      "1 തിമോത്തേയോസ്","2 തിമോത്തeyeyോസ്","തീത്തോസ്","****","ഫിലെമോ‌ന്‍",
      "ഹെബ്രായര്‍","യാക്കോബ്","1 പത്രോസ്","2 പത്രോസ്","1 യോഹന്നാ‌ന്‍",
      "2 യോഹന്നാ‌ന്‍","3 യോഹന്നാ‌ന്‍","യുദാസ്","****","വെളിപാട്"
    ];
    const bookOrder = new Map(BOOKS.map((b,i)=>[b,i]));

    // ---- Simple CSV parser (handles quoted fields) ----
    function parseCSV(text) {
      const rows = [];
      let row = [], field = "", inQuotes = false;
      for (let i=0;i<text.length;i++) {
        const c = text[i], nxt = text[i+1];
        if (inQuotes) {
          if (c === '"' && nxt === '"') { field += '"'; i++; }
          else if (c === '"') { inQuotes = false; }
          else { field += c; }
        } else {
          if (c === '"') inQuotes = true;
          else if (c === ',') { row.push(field); field = ""; }
          else if (c === '\n') { row.push(field); rows.push(row); row = []; field = ""; }
          else if (c === '\r') { /* ignore CR */ }
          else { field += c; }
        }
      }
      if (field.length || row.length) { row.push(field); rows.push(row); }
      const header = rows.shift() ?? [];
      return rows.map(r => Object.fromEntries(header.map((h,idx)=>[h, r[idx] ?? ""])));
    }

    // ---- Fetch & prepare data ----
    let DATA = [];
    let currentBook = "", currentChapter = "", currentVerse = "";

    async function loadData() {
      const res = await fetch("verses.csv", { cache: "no-store" });
      if (!res.ok) throw new Error("Failed to load verses.csv");
      const raw = await res.text();
      const rows = parseCSV(raw);

      // Derive Book/Chapter/Verse from Title if needed, normalize, and sort
      for (const row of rows) {
        const t = normalizeText(row["Title"]);
        if (t && t.includes(":")) {
          const [left, v] = t.split(":").map(normalizeText);
          const leftParts = left.split(" ");
          const ch = leftParts.pop() ?? "";
          const b = leftParts.join(" ");
          row.Book = normalizeText(row.Book || b);
          row.Chapter = normalizeText(row.Chapter || ch);
          row.Verse = normalizeText(row.Verse || v);
        } else {
          row.Book = normalizeText(row.Book);
          row.Chapter = normalizeText(row.Chapter);
          row.Verse = normalizeText(row.Verse);
        }
        row.Text = row.Text ?? "";
      }

      DATA = rows
        .filter(r => r.Book && r.Chapter && r.Verse)
        .sort((a,b) => {
          const ai = bookOrder.get(a.Book) ?? 9999;
          const bi = bookOrder.get(b.Book) ?? 9999;
          if (ai !== bi) return ai - bi;
          const ac = safeInt(a.Chapter), bc = safeInt(b.Chapter);
          if (ac !== bc) return ac - bc;
          return safeInt(a.Verse) - safeInt(b.Verse);
        });

      renderBooks();
    }

    // ---- UI: Books, Chapters, Verses ----
    const booksEl = document.getElementById("books");
    const chaptersEl = document.getElementById("chapters");
    const versesEl = document.getElementById("verses");
    const ntMarker = document.getElementById("ntMarker");

    function uniqueOrdered(arr) {
      const seen = new Set(); const out = [];
      for (const x of arr) if (!seen.has(x)) { seen.add(x); out.push(x); }
      return out;
    }

    function renderBooks() {
      booksEl.innerHTML = "";
      let sawNT = false;
      BOOKS.forEach((name, idx) => {
        if (name === "****") {
          const div = document.createElement("div");
          div.className = "divider";
          booksEl.appendChild(div);
          if (!sawNT && idx > 0) { sawNT = true; ntMarker.style.display = "block"; }
          return;
        }
        const btn = document.createElement("button");
        btn.className = "btn";
        btn.textContent = name;
        btn.onclick = () => selectBook(name);
        booksEl.appendChild(btn);
      });
    }

    function selectBook(book) {
      currentBook = book; currentChapter = ""; currentVerse = "";
      chaptersEl.innerHTML = ""; versesEl.innerHTML = "";

      const chapters = uniqueOrdered(
        DATA.filter(r => normalizeText(r.Book) === normalizeText(book))
            .map(r => normalizeText(r.Chapter))
            .filter(Boolean)
      );
      chapters.forEach(ch => {
        const b = document.createElement("button");
        b.className = "btn";
        b.textContent = ch;
        b.onclick = () => selectChapter(ch);
        chaptersEl.appendChild(b);
      });
    }

    function selectChapter(chapter) {
      currentChapter = chapter; currentVerse = "";
      versesEl.innerHTML = "";

      const verses = uniqueOrdered(
        DATA.filter(r =>
          normalizeText(r.Book) === normalizeText(currentBook) &&
          normalizeText(r.Chapter) === normalizeText(chapter)
        ).map(r => normalizeText(r.Verse)).filter(Boolean)
      );
      verses.forEach(v => {
        const b = document.createElement("button");
        b.className = "btn";
        b.textContent = v;
        b.onclick = () => openPresentation(currentBook, currentChapter, v);
        versesEl.appendChild(b);
      });
    }

    function openPresentation(book, chapter, verse) {
      currentVerse = verse;
      const url = new URL("presentation.html", location.href);
      url.searchParams.set("book", book);
      url.searchParams.set("chapter", chapter);
      url.searchParams.set("verse", verse);
      window.open(url.toString(), "_blank", "noopener,noreferrer");
    }

    // Init
    loadData().catch(err => {
      console.error(err);
      alert("Failed to load verses. Please ensure verses.csv is in the same folder.");
    });
  </script>
</body>
</html>
