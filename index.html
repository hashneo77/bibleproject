<!doctype html>
<html lang="ml">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bible Verse Navigator</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Malayalam:wght@400;700&display=swap" rel="stylesheet">
  <style>
    /* ---------------- THEME VARIABLES ON :root ----------------
       Default = DARK. Light overrides live on :root.light. */
    :root{
      --bg:#0b1324; --panel:#0e172b; --border:#22335a; --text:#f5f7fb; --muted:#9aa4b2;
      --btn-bg:#0e1527; --btn-hover:#101a33; --btn-border:#22335a;
      --accent:#0ea5e9; --header-glass:rgba(8,12,24,.7); --shadow:rgba(0,0,0,.35);
    }
    :root.light{
      --bg:#f5f6f7; --panel:#ffffff; --border:#d6d8db; --text:#111827; --muted:#6b7280;
      --btn-bg:#ffffff; --btn-hover:#f0f2f5; --btn-border:#c9ccd1;
      --accent:#0ea5e9; --header-glass:rgba(255,255,255,.7); --shadow:rgba(0,0,0,.12);
    }

    /* Base layout */
    *{ box-sizing:border-box; }
    html, body{
      margin:0; background:var(--bg); color:var(--text);
      font-family:"Noto Sans Malayalam", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    body{ min-height:100vh; }

    header{
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 16px; position:sticky; top:0; z-index:2;
      background:var(--header-glass); backdrop-filter:blur(6px);
      border-bottom:1px solid var(--border);
    }
    header h1{ margin:0; font-size:16px; font-weight:700; letter-spacing:.2px; }

    .wrap{ max-width:1280px; margin:14px auto 32px; padding:0 14px; }

    /* LabelFrame-style groups */
    .group{
      background:var(--panel); border:1px solid var(--border); border-radius:12px;
      margin:12px 0; padding:16px 14px 14px; position:relative;
      box-shadow:0 10px 28px var(--shadow);
    }
    .legend{
      position:absolute; top:-10px; left:12px; font-size:12px; color:var(--muted); letter-spacing:.2px;
      background:var(--bg); padding:0 8px; border:1px solid var(--border); border-radius:999px; line-height:20px;
    }

    /* Tighter grids to fit more buttons like your screenshot */
    .grid-books{
      display:grid; grid-template-columns: repeat(12, minmax(88px, 1fr)); gap:6px;
    }
    @media (max-width:1200px){ .grid-books{ grid-template-columns: repeat(9, minmax(84px,1fr)); } }
    @media (max-width:900px){  .grid-books{ grid-template-columns: repeat(6, minmax(82px,1fr)); } }
    @media (max-width:640px){  .grid-books{ grid-template-columns: repeat(3, minmax(78px,1fr)); } }

    .grid-tight{ display:grid; grid-template-columns: repeat(auto-fill, minmax(42px, 1fr)); gap:6px; }

    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      background:var(--btn-bg); color:var(--text);
      border:1px solid var(--btn-border); border-radius:8px;
      padding:4px 8px; min-height:28px; min-width:36px;
      font-size:12px; font-weight:700; letter-spacing:.1px;
      cursor:pointer; user-select:none; text-align:center;
      transition:background .15s ease, border-color .15s ease, transform .03s ease;
    }
    .btn:hover{ background:var(--btn-hover); border-color:#2b4271; }
    .btn:active{ transform:translateY(1px); }

    .divider{ grid-column:1 / -1; height:1px; background:linear-gradient(90deg, transparent, var(--border), transparent); margin:2px 0 6px; }
    .hint{ color:var(--muted); font-size:12px; margin-top:10px; }
    .verse {
      font-weight: 700; font-size: clamp(26px, 7vw, 52px); line-height: 1.25;
      text-align: center; white-space: pre-wrap;
      padding: 10px 8px; min-height: 180px; display: flex; align-items: center; justify-content: center;
    }
    .footer-note{
      text-align:center; font-size:11px; color:var(--muted);
      margin-top:14px; padding:6px 0 10px;
    }

    /* tiny icon button in header */
    .icon-btn{ min-width:34px; min-height:30px; padding:4px 6px; font-size:14px; }
  </style>
</head>
<body>
  <header>
    <h1>Bible Verse Navigator</h1>
    <button id="themeToggle" class="btn icon-btn" title="Toggle theme">‚òÄÔ∏è</button>
  </header>

  <div class="wrap">
    <section class="group">
      <div class="legend">Books</div>
      <div id="books" class="grid-books"></div>
    </section>

    <section class="group">
      <div class="legend">Chapters</div>
      <div id="chapters" class="grid-tight"></div>
    </section>

    <section class="group">
      <div class="legend">Verses</div>
      <div id="verses" class="grid-tight"></div>
    </section>

    <p class="hint"></p>
    <p class="footer-note">Made with &#x2665;&#xfe0f; by the Evangelisation Commission for Great Britain</p>
  </div>

  <script>
    /* ---------------- THEME (persist + no light strip) ---------------- */
    const THEME_KEY = "bible_theme";
    const root = document.documentElement; // <html>

    function applySavedTheme(){
      // Default to dark (no .light class). Add .light only for light theme.
      const saved = localStorage.getItem(THEME_KEY) || "dark";
      root.classList.toggle("light", saved === "light");
      document.getElementById("themeToggle").textContent = saved === "light" ? "üåô" : "‚òÄÔ∏è";
    }
    applySavedTheme();

    document.getElementById("themeToggle").addEventListener("click", ()=>{
      const nowLight = !root.classList.contains("light");
      root.classList.toggle("light", nowLight);
      localStorage.setItem(THEME_KEY, nowLight ? "light" : "dark");
      document.getElementById("themeToggle").textContent = nowLight ? "üåô" : "‚òÄÔ∏è";
    });

    // sync if another window changes it
    window.addEventListener("storage", (e)=>{ if(e.key === THEME_KEY) applySavedTheme(); });

    /* ---------------- Data & UI ---------------- */
    const norm = s => (s ?? "").normalize("NFKC").replace(/\u200d/g,"").replace(/\u00A0/g," ").trim();
    const toNum = s => { const n = parseInt(s,10); return Number.isFinite(n) ? n : -1; };
    const unique = arr => { const seen=new Set(); const out=[]; for(const x of arr){ if(!seen.has(x)){ seen.add(x); out.push(x);} } return out; };

    const BOOKS = [
      "‡¥â‡¥≤‡µç‚Äç‚Äç‡¥™‡¥§‡µç‡¥§‡¥ø","‡¥™‡µÅ‡¥±‡¥™‡µç‡¥™‡¥æ‡¥ü‡µç","‡¥≤‡µá‡¥µ‡µç‡¥Ø‡¥∞‡µç‚Äç","‡¥∏‡¥Ç‡¥ñ‡µç‡¥Ø","‡¥®‡¥ø‡¥Ø‡¥Æ‡¥æ‡¥µ‡¥∞‡µç‚Äç‡¥§‡µç‡¥§‡¥®‡¥Ç",
      "‡¥ú‡µã‡¥∑‡µç‡¥µ‡¥æ","‡¥®‡µç‡¥Ø‡¥æ‡¥Ø‡¥æ‡¥ß‡¥ø‡¥™‚Äå‡¥®‡µç‚Äç‡¥Æ‡¥æ‡¥∞‡µç‚Äç","‡¥±‡µÇ‡¥§‡µç‡¥§‡µç",
      "1 ‡¥∏‡¥æ‡¥Æ‡µÅ‡¥µ‡¥≤‡µç‚Äç","2 ‡¥∏‡¥æ‡¥Æ‡µÅ‡¥µ‡¥≤‡µç‚Äç","****","1 ‡¥∞‡¥æ‡¥ú‡¥æ‡¥ï‡µç‡¥ï‚Äå‡¥®‡µç‚Äç‡¥Æ‡¥æ‡¥∞‡µç‚Äç","2 ‡¥∞‡¥æ‡¥ú‡¥æ‡¥ï‡µç‡¥ï‚Äå‡¥®‡µç‚Äç‡¥Æ‡¥æ‡¥∞‡µç‚Äç",
      "1 ‡¥¶‡¥ø‡¥®‡¥µ‡µÉ‡¥§‡µç‡¥§‡¥æ‡¥®‡µç‡¥§‡¥Ç","2 ‡¥¶‡¥ø‡¥®‡¥µ‡µÉ‡¥§‡µç‡¥§‡¥æ‡¥®‡µç‡¥§‡¥Ç","‡¥é‡¥∏‡µç‡¥∞‡¥æ","‡¥®‡µÜ‡¥π‡¥Æ‡¥ø‡¥Ø","‡¥§‡µã‡¥¨‡¥ø‡¥§‡µç",
      "‡¥Ø‡µÇ‡¥¶‡¥ø‡¥§‡µç‡¥§‡µç","‡¥é‡¥∏‡µç‡¥§‡µá‡¥∞‡µç‚Äç","1 ‡¥Æ‡¥ï‡µç‡¥ï‡¥¨‡¥æ‡¥Ø‡¥∞‡µç‚Äç","2 ‡¥Æ‡¥ï‡µç‡¥ï‡¥¨‡¥æ‡¥Ø‡¥∞‡µç‚Äç","‡¥ú‡µã‡¥¨‡µç","****",
      "‡¥∏‡¥ô‡µç‡¥ï‡µÄ‡¥∞‡µç‚Äç‡¥§‡µç‡¥§‡¥®‡¥ô‡µç‡¥ô‡¥≥‡µç‚Äç","‡¥∏‡µÅ‡¥≠‡¥æ‡¥∑‡¥ø‡¥§‡¥ô‡µç‡¥ô‡¥≥‡µç‚Äç","‡¥∏‡¥≠‡¥æ‡¥™‡µç‡¥∞‡¥∏‡¥Ç‡¥ó‡¥ï‚Äå‡¥®‡µç‚Äç","****","‡¥â‡¥§‡µç‡¥§‡¥Æ‡¥ó‡µÄ‡¥§‡¥Ç",
      "‡¥ú‡µç‡¥û‡¥æ‡¥®‡¥Ç","‡¥™‡µç‡¥∞‡¥≠‡¥æ‡¥∑‡¥ï‚Äå‡¥®‡µç‚Äç","‡¥è‡¥∂‡¥Ø‡µç‡¥Ø‡¥æ","‡¥ú‡µÜ‡¥±‡µÜ‡¥Æ‡¥ø‡¥Ø","‡¥µ‡¥ø‡¥≤‡¥æ‡¥™‡¥ô‡µç‡¥ô‡¥≥‡µç‚Äç","‡¥¨‡¥æ‡¥±‡µÇ‡¥ï‡µç‡¥ï‡µç",
      "‡¥é‡¥∏‡µÜ‡¥ï‡µç‡¥ï‡¥ø‡¥Ø‡µá‡¥≤‡µç‚Äç","‡¥¶‡¥æ‡¥®‡¥ø‡¥Ø‡µá‡¥≤‡µç‚Äç","****","‡¥π‡µã‡¥∏‡¥ø‡¥Ø‡¥æ","‡¥ú‡µã‡¥Ø‡µá‡¥≤‡µç‚Äç","‡¥Ü‡¥Æ‡µã‡¥∏‡µç","‡¥í‡¥¨‡¥æ‡¥¶‡¥ø‡¥Ø",
      "‡¥Ø‡µã‡¥®‡¥æ","‡¥Æ‡¥ø‡¥ï‡µç‡¥ï‡¥æ","‡¥®‡¥æ‡¥π‡µÅ‡¥Ç","‡¥π‡¥¨‡¥ï‡µç‡¥ï‡µÅ‡¥ï‡µç‡¥ï‡µç","‡¥∏‡µÜ‡¥´‡¥æ‡¥®‡¥ø‡¥Ø","‡¥π‡¥ó‡µç‡¥ó‡¥æ‡¥Ø‡¥ø",
      "‡¥∏‡¥ñ‡¥±‡¥ø‡¥Ø‡¥æ","‡¥Æ‡¥≤‡¥æ‡¥ï‡µç‡¥ï‡¥ø","****","‡¥Æ‡¥§‡µç‡¥§‡¥æ‡¥Ø‡¥ø","‡¥Æ‡¥∞‡µç‚Äç‡¥ï‡µç‡¥ï‡µã‡¥∏‡µç","‡¥≤‡µÇ‡¥ï‡µç‡¥ï‡¥æ","‡¥Ø‡µã‡¥π‡¥®‡µç‡¥®‡¥æ‚Äå‡¥®‡µç‚Äç",
      "‡¥Ö‡¥™‡µç‡¥™. ‡¥™‡µç‡¥∞‡¥µ‡¥∞‡µç‚Äç‡¥§‡µç‡¥§‡¥®‡¥ô‡µç‡¥ô‡¥≥‡µç‚Äç","****","‡¥±‡µã‡¥Æ‡¥æ","1 ‡¥ï‡µä‡¥±‡¥ø‡¥®‡µç‡¥§‡µã‡¥∏‡µç","2 ‡¥ï‡µä‡¥±‡¥ø‡¥®‡µç‡¥§‡µã‡¥∏‡µç","‡¥ó‡¥≤‡¥æ‡¥§‡µç‡¥§‡¥ø‡¥Ø‡¥æ",
      "‡¥é‡¥´‡µá‡¥∏‡µã‡¥∏‡µç","‡¥´‡¥ø‡¥≤‡¥ø‡¥™‡µç‡¥™‡¥ø","‡¥ï‡µä‡¥≥‡µã‡¥∏‡µã‡¥∏‡µç","1 ‡¥§‡µÜ‡¥∏‡¥≤‡µã‡¥®‡¥ø‡¥ï‡µç‡¥ï‡¥æ","2 ‡¥§‡µÜ‡¥∏‡¥≤‡µã‡¥®‡¥ø‡¥ï‡µç‡¥ï‡¥æ",
      "1 ‡¥§‡¥ø‡¥Æ‡µã‡¥§‡µç‡¥§‡µá‡¥Ø‡µã‡¥∏‡µç","2 ‡¥§‡¥ø‡¥Æ‡µã‡¥§‡µç‡¥§‡µá‡¥Ø‡µã‡¥∏‡µç","‡¥§‡µÄ‡¥§‡µç‡¥§‡µã‡¥∏‡µç","****","‡¥´‡¥ø‡¥≤‡µÜ‡¥Æ‡µã‚Äå‡¥®‡µç‚Äç",
      "‡¥π‡µÜ‡¥¨‡µç‡¥∞‡¥æ‡¥Ø‡¥∞‡µç‚Äç","‡¥Ø‡¥æ‡¥ï‡µç‡¥ï‡µã‡¥¨‡µç","1 ‡¥™‡¥§‡µç‡¥∞‡µã‡¥∏‡µç","2 ‡¥™‡¥§‡µç‡¥∞‡µã‡¥∏‡µç","1 ‡¥Ø‡µã‡¥π‡¥®‡µç‡¥®‡¥æ‚Äå‡¥®‡µç‚Äç",
      "2 ‡¥Ø‡µã‡¥π‡¥®‡µç‡¥®‡¥æ‚Äå‡¥®‡µç‚Äç","3 ‡¥Ø‡µã‡¥π‡¥®‡µç‡¥®‡¥æ‚Äå‡¥®‡µç‚Äç","‡¥Ø‡µÅ‡¥¶‡¥æ‡¥∏‡µç","****","‡¥µ‡µÜ‡¥≥‡¥ø‡¥™‡¥æ‡¥ü‡µç"
    ];

    let ALL_ROWS = [];
    function parseCSV(text){
      const rows=[]; let row=[], field="", inQ=false;
      for(let i=0;i<text.length;i++){
        const c=text[i], n=text[i+1];
        if(inQ){ if(c==='"' && n==='"'){ field+='"'; i++; } else if(c==='"'){ inQ=false; } else { field+=c; } }
        else{ if(c==='"'){ inQ=true; } else if(c===','){ row.push(field); field=""; }
              else if(c==='\n'){ row.push(field); rows.push(row); row=[]; field=""; }
              else if(c==='\r'){ } else { field+=c; } }
      }
      if(field.length || row.length){ row.push(field); rows.push(row); }
      const header = rows.shift() || [];
      return rows.map(r => Object.fromEntries(header.map((h,i)=>[h, r[i] ?? ""])));
    }

    async function loadData(){
      const res = await fetch("verses.csv", { cache:"no-store" });
      if(!res.ok){ alert("verses.csv not found"); return; }
      const raw = await res.text();
      const rows = parseCSV(raw);
      for(const r of rows){
        const t = norm(r.Title);
        if(t && t.includes(":")){
          const [left, v] = t.split(":");
          const parts = norm(left).split(" ");
          const ch = parts.pop() ?? ""; const b = parts.join(" ");
          r.Book=norm(r.Book||b); r.Chapter=norm(r.Chapter||ch); r.Verse=norm(r.Verse||v);
        }else{
          r.Book=norm(r.Book); r.Chapter=norm(r.Chapter); r.Verse=norm(r.Verse);
        }
        r.Text = r.Text ?? "";
      }
      ALL_ROWS = rows.filter(r=>r.Book && r.Chapter && r.Verse);
      renderBooks();
    }

    const booksEl = document.getElementById("books");
    const chaptersEl = document.getElementById("chapters");
    const versesEl = document.getElementById("verses");

    // Truncate long book names to 6 chars visually (keep full for logic)
    function renderBooks(){
      booksEl.innerHTML = "";
      BOOKS.forEach(name=>{
        if(name==="****"){
          const d=document.createElement("div"); d.className="divider"; booksEl.appendChild(d);
        }else{
          const b=document.createElement("button");
          b.className="btn";
          const display = name.length>6 ? name.slice(0,6)+"‚Ä¶" : name;
          b.textContent = display;
          b.title = name;
          b.onclick = ()=>selectBook(name);
          booksEl.appendChild(b);
        }
      });
    }

    function selectBook(book){
      const chapters = unique(
        ALL_ROWS.filter(r => norm(r.Book)===norm(book)).map(r=>r.Chapter)
      ).sort((a,b)=>toNum(a)-toNum(b));

      chaptersEl.innerHTML=""; versesEl.innerHTML="";
      for(const ch of chapters){
        if(!ch) continue;
        const btn=document.createElement("button");
        btn.className="btn"; btn.textContent=ch;
        btn.onclick=()=>selectChapter(book, ch);
        chaptersEl.appendChild(btn);
      }
    }

    function selectChapter(book, chapter){
      const verses = unique(
        ALL_ROWS.filter(r => norm(r.Book)===norm(book) && norm(r.Chapter)===norm(chapter)).map(r=>r.Verse)
      ).sort((a,b)=>toNum(a)-toNum(b));

      versesEl.innerHTML="";
      for(const v of verses){
        if(!v) continue;
        const btn=document.createElement("button");
        btn.className="btn"; btn.textContent=v;
        btn.onclick=()=>openPresentation(book, chapter, v);
        versesEl.appendChild(btn);
      }
    }

    function openPresentation(book, chapter, verse){
      const url = new URL("presentation.html", location.href);
      url.searchParams.set("book", book);
      url.searchParams.set("chapter", chapter);
      url.searchParams.set("verse", verse);
      window.open(url.toString(), "_blank", "noopener,noreferrer");
    }

    loadData();
  </script>
</body>
</html>
